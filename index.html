<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated Title -->
    <title>Jessica B Designing</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.fonts.gstatic.com/s/inter/v13/UuauZp2EwK8y4XJc5_rSzhwV58T6_J1x1Q.woff2');
        body { font-family: 'Inter', sans-serif; }
        /* Custom style for the requested header background color (light pink/beige) */
        .header-bg {
            background-color: #fcf8f5; /* Light pink/beige color approximation */
        }
        /* Style for the collapsible panel */
        .collapsible-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }
        .collapsible-panel.is-expanded {
            max-height: 1000px; /* Large enough to accommodate the form content */
            padding-top: 1.5rem; /* p-6 equivalent for the top padding */
            padding-bottom: 1.5rem; /* p-6 equivalent for the bottom padding */
        }
        /* Style for the fixed Back to Top button */
        #back-to-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #back-to-top-btn.show {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-6 md:p-8">

    <div id="app-container" class="max-w-4xl mx-auto">
        <!-- HEADER: Updated with custom background, removed initial icon, added logo image to the right -->
        <header class="header-bg mb-8 p-4 rounded-lg shadow-lg">
            <h1 class="text-4xl font-bold text-gray-800 flex items-center justify-between">
                Jessica B Designing
                
                <!-- Logo Image: PATH UPDATED to assume the image is in assets/jessicab_logo.png -->
                <img src="assets/jessicab_logo.png" 
                     alt="Jessica B Designing Logo" 
                     class="h-20 w-30 rounded-lg object-contain border-2 border-amber-200 shadow-sm"
                     onerror="this.onerror=null;this.src='https://placehold.co/120x80/fcf8f5/886050?text=Logo+Error';"
                     title="JessaB DESIGNING Logo"
                >
            </h1>
        </header>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center p-8 text-indigo-600 font-medium">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Connecting to inventory database...
        </div>
        
        <!-- Collapsible Form Toggle Button -->
        <div id="form-toggle-section" class="mb-4 hidden">
            <button id="toggle-form-btn" class="w-full flex justify-between items-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out">
                <span id="form-toggle-text">Add New Inventory Item</span>
                <svg id="form-toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 transition-transform duration-300 transform rotate-0">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                </svg>
            </button>
        </div>
        
        <!-- Inventory Form Section (Now Collapsible) -->
        <div id="input-form-section" class="bg-white rounded-lg shadow-xl mb-8 collapsible-panel p-0">
            <div class="px-6 pb-6">
                 <h2 class="text-xl font-semibold text-gray-700 mb-4">Add New Item / Edit Details</h2>
                 <form id="inventory-form" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                     
                     <!-- Product Name -->
                     <div class="col-span-2 sm:col-span-3">
                         <label for="product-name" class="block text-sm font-medium text-gray-700">Product Name</label>
                         <input type="text" id="product-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                     </div>
         
                     <!-- Retail Cost (COGS) -->
                     <div>
                         <label for="retail-cost" class="block text-sm font-medium text-gray-700">Retail Cost ($)</label>
                         <input type="number" step="0.01" id="retail-cost" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" min="0">
                     </div>
         
                     <!-- Selling Price -->
                     <div>
                         <label for="selling-price" class="block text-sm font-medium text-gray-700">Selling Price ($)</label>
                         <input type="number" step="0.01" id="selling-price" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" min="0">
                     </div>
         
                     <!-- Size -->
                     <div>
                         <label for="size" class="block text-sm font-medium text-gray-700">Size (e.g., L, 32x30)</label>
                         <input type="text" id="size" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                     </div>
         
                     <!-- Quantity (Initial/Current Stock for Add/Edit) -->
                     <div>
                         <label for="quantity" class="block text-sm font-medium text-gray-700">Starting/Current Stock</label>
                         <input type="number" step="1" id="quantity" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" min="1">
                     </div>
         
                     <!-- Color -->
                     <div class="col-span-2 sm:col-span-1">
                         <label for="color" class="block text-sm font-medium text-gray-700">Color/Variant</label>
                         <input type="text" id="color" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                     </div>
         
                     <!-- Submit Button -->
                     <div class="col-span-2 sm:col-span-3 mt-2">
                         <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                             Add Item to Inventory
                         </button>
                     </div>
                 </form>
            </div>
        </div>
        
        <!-- Search Input Field -->
        <div id="search-section" class="mb-6 hidden">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.197 5.197a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                </div>
                <input type="text" id="search-input" placeholder="Search inventory by Name, Size, or Color..." class="block w-full rounded-lg border-0 py-3 pl-10 pr-4 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 shadow-md transition duration-150">
            </div>
        </div>

        <!-- Inventory List Section -->
        <div id="inventory-list-section" class="bg-white p-4 sm:p-6 rounded-lg shadow-xl mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Current Inventory Stock & Sales</h2>
                <!-- Button to scroll to financial summary -->
                <button id="scroll-to-summary-btn" class="bg-gray-200 text-gray-700 text-sm font-medium py-2 px-3 rounded-md hover:bg-gray-300 transition duration-150 flex items-center shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 18H7.5m-3-6h15m-1.5 0a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0" />
                    </svg>
                    View Financial Summary
                </button>
            </div>
            
            <div id="inventory-container" class="space-y-4">
                <!-- Items will be injected here -->
            </div>

            <p id="no-items-message" class="text-gray-500 text-center py-8 hidden">
                Your inventory is currently empty. Add an item above to get started!
            </p>
        </div>
        
        <!-- Financial Summary Section -->
        <div id="financial-summary" class="bg-indigo-700 p-4 sm:p-6 rounded-lg shadow-xl text-white mt-8 hidden">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2 text-indigo-300">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.03 60.03 0 0 0 18 0m-18 0v-2.25c0-1.31.25-2.58.73-3.72M2.25 18.75c-.32 0-.49-.13-.72-.37-.23-.24-.37-.41-.37-.73v-2.25c0-.62.08-1.22.24-1.8m.72 4.35v-2.25c0-.62.08-1.22.24-1.8m17.52 4.35v-2.25c0-.62.08-1.22.24-1.8m.24 4.05c.48-1.14.73-2.41.73-3.72V15c0-1.31-.25-2.58-.73-3.72m-17.52 7.8c.48-1.14.73-2.41.73-3.72V15c0-1.31-.25-2.58-.73-3.72M21.75 18.75c.32 0 .49-.13.72-.37.23-.24.37-.41.37-.73v-2.25c0-.62-.08-1.22-.24-1.8" />
                </svg>
                Overall Financial Summary
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                
                <div class="bg-white/10 p-4 rounded-md">
                    <p class="text-sm font-medium text-indigo-200">Total Stock Investment</p>
                    <p id="total-investment" class="text-2xl font-extrabold mt-1">$0.00</p>
                    <p class="text-xs text-indigo-300">(Cost of stock on hand)</p>
                </div>
                
                <div class="bg-white/10 p-4 rounded-md">
                    <p class="text-sm font-medium text-indigo-200">Total Sold Units</p>
                    <p id="total-sold-qty" class="text-2xl font-extrabold mt-1">0</p>
                    <p class="text-xs text-indigo-300">(All units recorded as sold)</p>
                </div>

                <div class="bg-white/10 p-4 rounded-md">
                    <p class="text-sm font-medium text-indigo-200">Total Realized Revenue</p>
                    <p id="total-revenue" class="text-2xl font-extrabold mt-1">$0.00</p>
                    <p class="text-xs text-indigo-300">(Money collected from sales)</p>
                </div>

                <div class="bg-white/20 p-4 rounded-md border-2 border-green-300">
                    <p class="text-sm font-medium text-green-300">TOTAL REALIZED PROFIT</p>
                    <p id="total-profit" class="text-3xl font-extrabold mt-1">$0.00</p>
                    <p class="text-xs text-indigo-300">(Revenue - Cost of goods sold)</p>
                </div>
            </div>
        </div>

        <!-- Custom Modal for Confirmation/Error -->
        <div id="custom-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="modal-content" class="text-sm text-gray-500"></p>
                    </div>
                    <div id="modal-button-container" class="items-center px-4 py-3">
                        <button id="modal-close-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none transition duration-150">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- NEW: Back to Top Button -->
    <button id="back-to-top-btn" onclick="scrollToTop()" class="p-3 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 18.75 7.5-7.5 7.5 7.5" />
            <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 7.5-7.5 7.5 7.5" />
        </svg>
    </button>
    <!-- END NEW: Back to Top Button -->

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- MANDATORY FIREBASE SETUP ---
        setLogLevel('error'); 

        // Global variables for Firebase objects and current data state
        let app, db, auth, userId = null;
        let currentItems = []; // Stores the latest snapshot data for quick lookups

        // User-provided Firebase Configuration (used as a fallback for local testing)
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyBiLhE-lIBpw5vKH5R-qJ4GJk3Xw-cLQpE",
            authDomain: "jbdinventory1.firebaseapp.com",
            projectId: "jbdinventory1",
            storageBucket: "jbdinventory1.firebasestorage.app",
            messagingSenderId: "54830668934",
            appId: "1:54830668934:web:90e3cb6ad381347f4a4507",
            measurementId: "G-X3M70499ZG"
        };
        
        // Configuration retrieval
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Use environment config if available, otherwise use the user's provided default config
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : defaultFirebaseConfig; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const COLLECTION_PATH = `artifacts/${appId}/public/data/apparel_inventory`;

        // UI elements
        const loadingEl = document.getElementById('loading');
        const formToggleBtn = document.getElementById('toggle-form-btn'); 
        const formToggleText = document.getElementById('form-toggle-text'); 
        const formToggleIcon = document.getElementById('form-toggle-icon'); 
        const formSection = document.getElementById('input-form-section');
        const listSection = document.getElementById('inventory-list-section');
        const inventoryForm = document.getElementById('inventory-form');
        const inventoryContainer = document.getElementById('inventory-container');
        const noItemsMessage = document.getElementById('no-items-message');
        const financialSummary = document.getElementById('financial-summary');
        const totalInvestmentEl = document.getElementById('total-investment');
        const totalRevenueEl = document.getElementById('total-revenue');
        const totalProfitEl = document.getElementById('total-profit');
        const searchSection = document.getElementById('search-section'); 
        const searchInput = document.getElementById('search-input');
        const totalSoldQtyEl = document.getElementById('total-sold-qty');
        const scrollToSummaryBtn = document.getElementById('scroll-to-summary-btn'); 
        const formToggleSection = document.getElementById('form-toggle-section'); 

        // Modal elements
        const modalEl = document.getElementById('custom-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalContentEl = document.getElementById('modal-content');
        const modalButtonContainer = document.getElementById('modal-button-container');
        
        // NEW: Back to Top Button element initialization
        const backToTopBtn = document.getElementById('back-to-top-btn');


        // State for editing
        let editingDocId = null;

        // --- UTILITY FUNCTIONS ---
        
        // Template for the default single OK button
        const DEFAULT_OK_BUTTON_HTML = `
            <button id="modal-close-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none transition duration-150">
                OK
            </button>
        `;

        function setupSimpleModalCloseHandler() {
            // Find the current close button element (it might have been replaced)
            const closeBtn = document.getElementById('modal-close-btn');
            if (closeBtn) {
                closeBtn.onclick = () => {
                    modalEl.classList.add('hidden');
                };
            }
        }
        
        // Set up the initial close handler on load
        setupSimpleModalCloseHandler();

        // New function to toggle the form visibility
        function toggleForm() {
            const isExpanded = formSection.classList.toggle('is-expanded');
            
            if (isExpanded) {
                formToggleIcon.classList.add('rotate-180');
                formToggleText.textContent = 'Hide Inventory Form';
            } else {
                formToggleIcon.classList.remove('rotate-180');
                formToggleText.textContent = 'Add New Inventory Item';
                // Reset form state if collapsing
                inventoryForm.reset();
                editingDocId = null;
                const submitButton = inventoryForm.querySelector('button[type="submit"]');
                submitButton.textContent = 'Add Item to Inventory';
                submitButton.classList.remove('bg-orange-500', 'hover:-bg-orange-600');
                submitButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
        }
        
        // New function to scroll to the financial summary
        function scrollToSummary() {
             financialSummary.scrollIntoView({ behavior: 'smooth' });
        }
        
        // NEW: Function to handle scrolling to top (made a property of window for onclick access)
        window.scrollToTop = function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showModal(title, content) {
            // 1. Ensure the button container is reset to the default OK button HTML
            modalButtonContainer.innerHTML = DEFAULT_OK_BUTTON_HTML;
            
            // 2. Attach the simple close handler to the newly created button
            setupSimpleModalCloseHandler();

            // 3. Set content and display
            modalTitleEl.textContent = title;
            modalContentEl.textContent = content;
            modalEl.classList.remove('hidden');
        }

        // Function to handle exponential backoff and retry (simplified version for context)
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    console.error(`Fetch attempt ${i + 1} failed:`, error);
                    if (i === maxRetries - 1) throw error; 
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // NEW: Scroll event listener logic to show/hide the button
        function handleScroll() {
            if (backToTopBtn) {
                if (window.scrollY > 300) { // Show button after scrolling 300px down
                    backToTopBtn.classList.add('show');
                } else {
                    backToTopBtn.classList.remove('show');
                }
            }
        }


        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
        async function initializeFirebase() {
            // Check if firebaseConfig is valid (either from runtime or fallback)
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Firebase config is missing or invalid.");
                showModal("Configuration Error", "Firebase configuration is missing or invalid. Cannot initialize the app.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for the auth state to settle
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        // Show the app UI and start listening to data
                        loadingEl.classList.add('hidden');
                        formToggleSection.classList.remove('hidden'); // Show toggle button
                        listSection.classList.remove('hidden');
                        financialSummary.classList.remove('hidden'); 
                        searchSection.classList.remove('hidden');
                        loadProducts();
                        
                        // Attach listeners
                        searchInput.addEventListener('input', () => {
                            renderInventory(currentItems);
                        });
                        
                        formToggleBtn.addEventListener('click', toggleForm);
                        scrollToSummaryBtn.addEventListener('click', scrollToSummary);
                        
                    } else {
                        // Handle failure case if needed, but for anonymous sign-in, it usually succeeds.
                        loadingEl.classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showModal("Initialization Failed", `An error occurred during startup: ${error.message}`);
            }
        }
        
        // --- CRUD OPERATIONS ---

        // 1. Save (Add/Update) Product
        async function saveProduct(productData, docId = null) {
            if (!db) {
                console.error("Database not initialized.");
                return;
            }

            try {
                if (docId) {
                    const docRef = doc(db, COLLECTION_PATH, docId);
                    await updateDoc(docRef, productData);
                } else {
                    await addDoc(collection(db, COLLECTION_PATH), productData);
                }
                showModal("Success!", `Inventory item ${docId ? 'updated' : 'added'} successfully.`);
            } catch (error) {
                console.error("Error saving product:", error);
                showModal("Database Error", `Failed to save item: ${error.message}`);
            }
        }
        
        // 2. Update Stock/Sales Quantity
        async function updateStock(docId, changeType) {
            if (!db) return;

            try {
                const docRef = doc(db, COLLECTION_PATH, docId);
                let updatePayload = {};

                if (changeType === 'sell') {
                    updatePayload = {
                        quantity: increment(-1),
                        salesQuantity: increment(1)
                    };
                } else if (changeType === 'restock') {
                    updatePayload = {
                        quantity: increment(1)
                    };
                } else {
                    return;
                }

                await updateDoc(docRef, updatePayload);
            } catch (error) {
                console.error(`Error updating stock (${changeType}):`, error);
                showModal("Update Error", `Failed to update inventory: ${error.message}`);
            }
        }


        // 3. Delete Product
        async function deleteProduct(docId) {
            if (!db) return;

            // Custom modal for confirmation
            const confirmDelete = () => new Promise(resolve => {
                
                // Display confirmation message
                modalTitleEl.textContent = "Confirm Deletion";
                modalContentEl.textContent = "Are you sure you want to delete this inventory item? This cannot be undone.";
                
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-1/2 shadow-sm hover:bg-red-700 transition duration-150 mr-2';

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.className = 'px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md w-1/2 shadow-sm hover:bg-gray-400 transition duration-150';

                // Clear existing content and append new buttons
                modalButtonContainer.innerHTML = '';
                modalButtonContainer.appendChild(deleteButton);
                modalButtonContainer.appendChild(cancelButton);

                modalEl.classList.remove('hidden');

                // Function to restore the modal to its original simple message state
                const restoreModal = () => {
                    modalTitleEl.textContent = ""; 
                    modalContentEl.textContent = "";
                    // Restore the default HTML which also creates the modal-close-btn element
                    modalButtonContainer.innerHTML = DEFAULT_OK_BUTTON_HTML;
                    // Re-attach the simple close handler to the newly restored element
                    setupSimpleModalCloseHandler(); 
                    
                    modalEl.classList.add('hidden');
                };

                deleteButton.onclick = () => { 
                    resolve(true); 
                    restoreModal(); // Restore UI after resolution
                };
                cancelButton.onclick = () => { 
                    resolve(false); 
                    restoreModal(); // Restore UI after resolution
                };
            });

            if (await confirmDelete()) {
                try {
                    await deleteDoc(doc(db, COLLECTION_PATH, docId));
                    showModal("Deleted", "Item successfully removed from inventory.");
                } catch (error) {
                    console.error("Error deleting product:", error);
                    showModal("Database Error", `Failed to delete item: ${error.message}`);
                }
            }
        }

        // 4. Load Products (Real-time with onSnapshot)
        function loadProducts() {
            if (!db) return;

            const q = query(collection(db, COLLECTION_PATH));

            onSnapshot(q, (snapshot) => {
                const items = [];
                snapshot.forEach((doc) => {
                    items.push({ id: doc.id, ...doc.data() });
                });
                
                currentItems = items; // Update the global state
                renderInventory(currentItems); // Render the full list (which handles filtering)
            }, (error) => {
                console.error("Error fetching documents:", error);
                showModal("Data Error", `Could not load inventory: ${error.message}`);
            });
        }
        
        // --- UI RENDERING & EVENT HANDLERS ---
        
        function editProduct(item) {
            editingDocId = item.id;
            document.getElementById('product-name').value = item.productName;
            document.getElementById('retail-cost').value = item.retailCost;
            document.getElementById('selling-price').value = item.sellingPrice;
            document.getElementById('size').value = item.size;
            document.getElementById('quantity').value = item.quantity; 
            document.getElementById('color').value = item.color;
            
            const submitButton = inventoryForm.querySelector('button[type="submit"]');
            submitButton.textContent = `Update "${item.productName}"`;
            submitButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            submitButton.classList.add('bg-orange-500', 'hover:bg-orange-600');
            
            // Open the form/dropdown when editing
            if (!formSection.classList.contains('is-expanded')) {
                toggleForm();
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Render the list of inventory items AND calculate totals
        function renderInventory(items) {
            inventoryContainer.innerHTML = '';

            // Filtering Logic
            const searchTerm = searchInput.value.toLowerCase().trim();
            const filteredItems = items.filter(item => {
                // Search across Name, Size, and Color fields
                const searchString = `${item.productName} ${item.size} ${item.color}`.toLowerCase();
                return searchString.includes(searchTerm);
            });


            // Initialize accumulators for totals
            // NOTE: Only used for calculating totals across ALL items, not filtered.
            let globalTotalInvestment = 0;
            let globalTotalRealizedRevenue = 0;
            let globalTotalRealizedCostOfSoldGoods = 0;
            let globalTotalSoldQuantity = 0; 

            if (filteredItems.length === 0) {
                noItemsMessage.classList.remove('hidden');
            } else {
                noItemsMessage.classList.add('hidden');
            }
            
            // Sort by product name
            filteredItems.sort((a, b) => a.productName.localeCompare(b.productName));

            filteredItems.forEach(item => {
                // Calculations
                const retailCost = parseFloat(item.retailCost);
                const sellingPrice = parseFloat(item.sellingPrice);
                const currentStock = parseInt(item.quantity, 10);
                const salesQuantity = parseInt(item.salesQuantity || 0, 10); 
                
                const grossProfitPerUnit = sellingPrice - retailCost;
                const totalProfitFromSales = grossProfitPerUnit * salesQuantity; 
                
                const totalProfitColor = totalProfitFromSales > 0 ? 'text-green-700' : (totalProfitFromSales < 0 ? 'text-red-700' : 'text-gray-700');

                
                const itemHtml = `
                    <div class="bg-white p-4 border border-gray-100 rounded-lg shadow-md hover:shadow-lg transition duration-200 sm:flex sm:justify-between sm:items-center">
                        <!-- Item Details (Left Side) -->
                        <div class="flex-grow mb-3 sm:mb-0">
                            <div class="text-lg font-bold text-gray-800">${item.productName}</div>
                            <div class="text-sm text-gray-500">Size: ${item.size} â€¢ Color: ${item.color}</div>
                            
                            <div class="mt-2 grid grid-cols-2 text-sm gap-y-1">
                                <!-- Updated display for Stock and Sold -->
                                <div><span class="font-medium text-gray-600">Stock Qty:</span> <span class="text-indigo-600 font-semibold">${currentStock}</span></div>
                                <div><span class="font-medium text-gray-600">Sold Qty:</span> <span class="text-indigo-600 font-semibold">${salesQuantity}</span></div>
                                
                                <div><span class="font-medium text-gray-600">Retail Cost:</span> $${retailCost.toFixed(2)}</div>
                                <div><span class="font-medium text-gray-600">Selling Price:</span> $${sellingPrice.toFixed(2)}</div>
                            </div>
                        </div>

                        <!-- Financials & Actions (Right Side) -->
                        <div class="sm:ml-4 sm:w-64 flex flex-col space-y-2">
                            <!-- Total Profit from Sales -->
                            <div class="bg-green-50 p-2 rounded-md">
                                <p class="text-xs font-medium text-gray-600">Total Profit (Realized)</p>
                                <p class="${totalProfitColor} font-bold text-lg">$${totalProfitFromSales.toFixed(2)}</p>
                            </div>
                            
                            <!-- Profit Per Unit -->
                            <div class="bg-indigo-50 p-2 rounded-md">
                                <p class="text-xs font-medium text-gray-600">Profit/Unit</p>
                                <p class="${grossProfitPerUnit > 0 ? 'text-green-700' : 'text-red-700'} font-bold text-lg">$${grossProfitPerUnit.toFixed(2)}</p>
                            </div>

                            <!-- Sales/Stock Buttons -->
                            <div class="flex space-x-2">
                                <button data-id="${item.id}" data-action="sell" ${currentStock <= 0 ? 'disabled' : ''} class="flex-1 py-1 text-sm rounded-md bg-green-500 hover:bg-green-600 text-white transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Record Sale (-1)
                                </button>
                                <button data-id="${item.id}" data-action="restock" class="flex-1 py-1 text-sm rounded-md bg-blue-500 hover:bg-blue-600 text-white transition duration-150">
                                    Restock (+1)
                                </button>
                            </div>

                            <!-- Edit/Delete Buttons -->
                            <div class="flex space-x-2">
                                <button data-id="${item.id}" data-action="edit" class="flex-1 py-1 text-sm rounded-md bg-yellow-400 hover:bg-yellow-500 text-gray-800 transition duration-150">Edit Details</button>
                                <button data-id="${item.id}" data-action="delete" class="flex-1 py-1 text-sm rounded-md bg-red-500 hover:bg-red-600 text-white transition duration-150">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                inventoryContainer.innerHTML += itemHtml;
            });

            // --- START: GLOBAL FINANCIAL SUMMARY CALCULATION (Uses ALL items) ---

            items.forEach(item => {
                const retailCost = parseFloat(item.retailCost);
                const sellingPrice = parseFloat(item.sellingPrice);
                const currentStock = parseInt(item.quantity, 10);
                const salesQuantity = parseInt(item.salesQuantity || 0, 10); 
                
                globalTotalInvestment += (currentStock * retailCost);
                globalTotalRealizedRevenue += (salesQuantity * sellingPrice);
                globalTotalRealizedCostOfSoldGoods += (salesQuantity * retailCost);
                globalTotalSoldQuantity += salesQuantity; 
            });
            
            const finalTotalProfit = globalTotalRealizedRevenue - globalTotalRealizedCostOfSoldGoods;

            // --- END: GLOBAL FINANCIAL SUMMARY CALCULATION ---

            // UPDATE UI ELEMENTS
            totalInvestmentEl.textContent = `$${globalTotalInvestment.toFixed(2)}`;
            totalRevenueEl.textContent = `$${globalTotalRealizedRevenue.toFixed(2)}`;
            totalSoldQtyEl.textContent = globalTotalSoldQuantity; 
            totalProfitEl.textContent = `$${finalTotalProfit.toFixed(2)}`;
            
            if (finalTotalProfit < 0) {
                 totalProfitEl.classList.remove('text-green-300');
                 totalProfitEl.classList.add('text-red-300');
                 totalProfitEl.parentElement.classList.remove('border-green-300');
                 totalProfitEl.parentElement.classList.add('border-red-300');
            } else {
                 totalProfitEl.classList.add('text-green-300');
                 totalProfitEl.classList.remove('text-red-300');
                 totalProfitEl.parentElement.classList.add('border-green-300');
                 totalProfitEl.parentElement.classList.remove('border-red-300');
            }
        }
        
        // Global event listener for all item-related buttons
        inventoryContainer.addEventListener('click', (event) => {
            const button = event.target.closest('button');
            if (!button) return;

            const docId = button.dataset.id;
            const action = button.dataset.action;
            const item = currentItems.find(i => i.id === docId); 

            if (!item) {
                console.error("Item not found for action.");
                return;
            }

            if (action === 'edit') {
                editProduct(item);
            } else if (action === 'delete') {
                deleteProduct(docId);
            } else if (action === 'sell') { 
                if (item.quantity > 0) {
                    updateStock(docId, 'sell');
                } else {
                    showModal("Stock Zero", "Cannot record a sale: Stock quantity is already 0.");
                }
            } else if (action === 'restock') { 
                updateStock(docId, 'restock');
            }
        });

        // Form submission handler
        inventoryForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const productName = document.getElementById('product-name').value.trim();
            const retailCost = parseFloat(document.getElementById('retail-cost').value);
            const sellingPrice = parseFloat(document.getElementById('selling-price').value);
            const size = document.getElementById('size').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value, 10);
            const color = document.getElementById('color').value.trim();
            
            if (retailCost < 0 || sellingPrice < 0 || quantity <= 0) {
                 showModal("Input Error", "Cost, price, and initial quantity must be valid positive numbers.");
                 return;
            }

            const productData = {
                productName,
                retailCost: retailCost,
                sellingPrice: sellingPrice,
                size,
                quantity: quantity, 
                salesQuantity: editingDocId ? (currentItems.find(i => i.id === editingDocId)?.salesQuantity || 0) : 0, 
                color,
                timestamp: Date.now(), 
            };

            await saveProduct(productData, editingDocId);
            
            // Reset form and state after successful save/update
            inventoryForm.reset();
            editingDocId = null;
            const submitButton = inventoryForm.querySelector('button[type="submit"]');
            submitButton.textContent = 'Add Item to Inventory';
            submitButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            submitButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            
            // Collapse the form after adding/updating
            if (formSection.classList.contains('is-expanded')) {
                toggleForm();
            }
        });

        // NEW: Register the scroll listener immediately so the button appears promptly.
        if (backToTopBtn) {
            window.addEventListener('scroll', handleScroll);
        }

        // Start the application
        window.onload = initializeFirebase;
    </script>
</body>
</html>
