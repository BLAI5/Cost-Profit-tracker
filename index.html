<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JessaB Designing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.fonts.gstatic.com/s/inter/v13/UuauZp2EwK8y4XJc5_rSzhwV58T6_J1x1Q.woff2');
        body { font-family: 'Inter', sans-serif; }
        .header-bg { background-color: #fcf8f5; }
        .collapsible-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }
        .collapsible-panel.is-expanded {
            max-height: 1000px;
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
        }
        #back-to-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #back-to-top-btn.show { opacity: 1; visibility: visible; }
        .custom-select-tag {
            display: inline-flex;
            align-items: center;
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 0.25rem 0.5rem;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        /* --- BASIC PRINT STYLES --- */
        @media print {
            body { background-color: white !important; color: black !important; }
            #app-container { max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
            
            /* Hide UI controls */
            #form-toggle-section, #input-form-section, #search-section, 
            #back-to-top-btn, #category-modal, #manage-categories-btn, 
            #custom-modal, .no-print, button { 
                display: none !important; 
            }

            /* Simplified Inventory Header for Print */
            header {
                background-color: transparent !important;
                border-bottom: 2px solid black;
                margin-bottom: 20px !important;
                padding: 10px 0 !important;
            }
            header h1 { font-size: 24pt !important; }
            header img { height: 60px !important; width: auto !important; }

            /* Simplify Item List: Only Name, Color, Size, Qty */
            #inventory-container { display: block !important; }
            #inventory-container .bg-white {
                border: none !important;
                border-bottom: 1px solid #eee !important;
                padding: 8px 0 !important;
                box-shadow: none !important;
                display: flex !important;
                justify-content: b-between !important;
                align-items: center !important;
                page-break-inside: avoid;
            }

            /* Hide categories, financial labels, and extra buttons on items */
            #inventory-container .flex-wrap,
            #inventory-container .grid,
            #inventory-container .sm\:w-64,
            #inventory-container .mt-2.text-xs {
                display: none !important;
            }

            /* Show Name, Color, Size, Qty in a clean row */
            #inventory-container .text-lg.font-bold::after {
                content: " - " attr(data-details);
                font-weight: normal;
                font-size: 11pt;
            }
            
            /* Data reference at bottom */
            #financial-summary-container { margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 20px; }
            #financial-summary { 
                background: white !important; 
                color: black !important; 
                border: 1px solid black !important;
                box-shadow: none !important;
            }
            #financial-summary * { color: black !important; }
            #financial-summary .bg-white\/10 { border: 1px solid #ddd !important; }
            #category-summaries .bg-white { border: 1px solid #ddd !important; box-shadow: none !important; }
            /* Hide history lists in print */
            [id^="transaction-list-"] { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-6 md:p-8">

    <div id="app-container" class="max-w-4xl mx-auto">
        <header class="header-bg mb-8 p-4 rounded-lg shadow-lg">
            <h1 class="text-4xl font-bold text-gray-800 flex items-center justify-between">
                JessaB Designing
                <img src="assets/jessicab_logo.png" 
                     alt="Logo" 
                     class="h-20 w-30 rounded-lg object-contain border-2 border-amber-200 shadow-sm"
                     onerror="this.onerror=null;this.src='https://placehold.co/120x80/fcf8f5/886050?text=Logo';"
                >
            </h1>
        </header>

        <div id="loading" class="text-center p-8 text-indigo-600 font-medium">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            Loading...
        </div>
        
        <div id="form-toggle-section" class="mb-4 hidden">
            <button id="toggle-form-btn" class="w-full flex justify-between items-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">
                <span id="form-toggle-text">Add New Inventory Item</span>
                <svg id="form-toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 transition-transform"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
            </button>
        </div>
        
        <div id="input-form-section" class="bg-white rounded-lg shadow-xl mb-8 collapsible-panel p-0">
            <div class="px-6 pb-6">
                 <h2 class="text-xl font-semibold text-gray-700 mb-4">Item Details</h2>
                 <form id="inventory-form" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                     <div class="col-span-2 sm:col-span-3">
                         <label class="block text-sm font-medium text-gray-700">Product Name</label>
                         <input type="text" id="product-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                     </div>
                     <div>
                         <label class="block text-sm font-medium text-gray-700">Retail Cost ($)</label>
                         <input type="number" step="0.01" id="retail-cost" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                     </div>
                     <div>
                         <label class="block text-sm font-medium text-gray-700">Selling Price ($)</label>
                         <input type="number" step="0.01" id="selling-price" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                     </div>
                     <div>
                         <label class="block text-sm font-medium text-gray-700">Size</label>
                         <input type="text" id="size" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                     </div>
                     <div>
                         <label class="block text-sm font-medium text-gray-700">Current Stock</label>
                         <input type="number" id="quantity" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                     </div>
                     <div class="col-span-2 sm:col-span-1">
                         <label class="block text-sm font-medium text-gray-700">Color</label>
                         <input type="text" id="color" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                     </div>
                     <div class="col-span-2 sm:col-span-3">
                         <label class="block text-sm font-medium text-gray-700 mb-1">Categories</label>
                         <div class="flex items-start space-x-2">
                             <select id="categories" multiple class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border h-24" required></select>
                             <button type="button" id="manage-categories-btn" class="p-2.5 mt-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 18H7.5m-3-6h15m-1.5 0a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0" /></svg>
                             </button>
                         </div>
                     </div>
                     <div class="col-span-2 sm:col-span-3 mt-2">
                         <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition font-medium">Add Item to Inventory</button>
                     </div>
                 </form>
            </div>
        </div>
        
        <div id="search-section" class="mb-6 hidden">
            <input type="text" id="search-input" placeholder="Search Name, Size, Color, or Category..." class="block w-full rounded-lg border-gray-300 py-3 px-4 shadow-md ring-1 ring-gray-300">
        </div>

        <div id="inventory-list-section" class="bg-white p-4 sm:p-6 rounded-lg shadow-xl mb-8 hidden">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                <h2 class="text-xl font-semibold text-gray-700">Inventory Stock</h2>
                <div class="flex space-x-2 no-print">
                    <button onclick="window.print()" class="bg-gray-200 text-gray-700 text-sm font-medium py-2 px-3 rounded-md hover:bg-gray-300 flex items-center shadow-sm">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z" /></svg>
                        Print Basic List
                    </button>
                    <button id="scroll-to-summary-btn" class="bg-gray-200 text-gray-700 text-sm font-medium py-2 px-3 rounded-md hover:bg-gray-300">Financial Summary</button>
                </div>
            </div>
            
            <div id="inventory-container" class="space-y-4"></div>
            <p id="no-items-message" class="text-gray-500 text-center py-8 hidden">Inventory is empty.</p>
        </div>
        
        <div id="financial-summary-container">
            <div id="financial-summary" class="bg-indigo-700 p-6 rounded-lg shadow-xl text-white mt-8 hidden">
                <h2 class="text-xl font-bold mb-4">Financial Summary</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-white/10 p-4 rounded-md"><p class="text-sm">Stock Investment</p><p id="total-investment" class="text-2xl font-bold mt-1">$0.00</p></div>
                    <div class="bg-white/10 p-4 rounded-md"><p class="text-sm">Sold Units</p><p id="total-sold-qty" class="text-2xl font-bold mt-1">0</p></div>
                    <div class="bg-white/10 p-4 rounded-md"><p class="text-sm">Realized Revenue</p><p id="total-revenue" class="text-2xl font-bold mt-1">$0.00</p></div>
                    <div class="bg-white/20 p-4 rounded-md border-2 border-green-300"><p class="text-sm">TOTAL PROFIT</p><p id="total-profit" class="text-3xl font-extrabold mt-1">$0.00</p></div>
                </div>
            </div>
            <div id="category-summaries" class="mt-8 space-y-4"></div>
        </div>

        <!-- Modals -->
        <div id="custom-modal" class="hidden fixed inset-0 bg-gray-600/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-md shadow-lg max-w-sm w-full text-center">
                <h3 id="modal-title" class="text-lg font-bold"></h3>
                <p id="modal-content" class="mt-2 text-gray-500"></p>
                <div id="modal-button-container" class="mt-4"></div>
            </div>
        </div>

        <div id="category-modal" class="hidden fixed inset-0 bg-gray-600/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-md shadow-lg max-w-md w-full">
                <h3 class="text-xl font-bold mb-4">Manage Categories</h3>
                <form id="add-category-form" class="flex mb-4"><input type="text" id="new-category-name" required class="flex-grow border rounded-l p-2"><button type="submit" class="bg-indigo-600 text-white px-4 rounded-r">Add</button></form>
                <div id="category-list-container" class="space-y-2 max-h-64 overflow-y-auto bg-gray-50 p-2 border"></div>
                <div class="mt-4 text-right"><button id="close-category-modal-btn" class="px-4 py-2 bg-gray-300 rounded">Done</button></div>
            </div>
        </div>
    </div>

    <button id="back-to-top-btn" onclick="scrollToTop()" class="p-3 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="m4.5 18.75 7.5-7.5 7.5 7.5m-15-6 7.5-7.5 7.5 7.5" /></svg>
    </button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, increment, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, userId = null;
        let currentItems = [];
        let currentSales = [];
        let currentCategories = [];
        let editingDocId = null;

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'inventory-app';

        async function init() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('form-toggle-section').classList.remove('hidden');
                    document.getElementById('list-section')?.classList.remove('hidden'); // Simplified
                    document.getElementById('inventory-list-section').classList.remove('hidden');
                    document.getElementById('financial-summary').classList.remove('hidden');
                    document.getElementById('search-section').classList.remove('hidden');
                    
                    setupListeners();
                    loadData();
                }
            });
        }

        function setupListeners() {
            document.getElementById('inventory-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('toggle-form-btn').addEventListener('click', toggleForm);
            document.getElementById('search-input').addEventListener('input', () => renderInventory());
            document.getElementById('manage-categories-btn').addEventListener('click', () => document.getElementById('category-modal').classList.remove('hidden'));
            document.getElementById('close-category-modal-btn').addEventListener('click', () => document.getElementById('category-modal').classList.add('hidden'));
            document.getElementById('add-category-form').addEventListener('submit', handleAddCategory);
            document.getElementById('scroll-to-summary-btn').addEventListener('click', () => document.getElementById('financial-summary-container').scrollIntoView({behavior:'smooth'}));
            window.addEventListener('scroll', () => {
                const btn = document.getElementById('back-to-top-btn');
                if (window.scrollY > 300) btn.classList.add('show'); else btn.classList.remove('show');
            });
        }

        function loadData() {
            onSnapshot(doc(db, `artifacts/${appId}/public/data/categories/list`), snap => {
                currentCategories = snap.exists() ? snap.data().names : [];
                renderCategoriesUI();
            });

            onSnapshot(query(collection(db, `artifacts/${appId}/public/data/apparel_inventory`)), snap => {
                currentItems = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderInventory();
            });

            onSnapshot(query(collection(db, `artifacts/${appId}/public/data/sales_ledger`)), snap => {
                currentSales = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderInventory();
            });
        }

        function renderInventory() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = currentItems.filter(i => 
                i.productName.toLowerCase().includes(term) || 
                i.color.toLowerCase().includes(term) || 
                i.size.toLowerCase().includes(term)
            ).sort((a,b) => a.productName.localeCompare(b.productName));

            const container = document.getElementById('inventory-container');
            container.innerHTML = '';
            
            filtered.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white p-4 border rounded-lg shadow-md flex justify-between items-center';
                // These data attributes are used by CSS @media print to show basic info
                itemEl.innerHTML = `
                    <div class="flex-grow">
                        <div class="text-lg font-bold text-gray-800" data-details="Color: ${item.color}, Size: ${item.size}, Qty: ${item.quantity}">
                            ${item.productName}
                        </div>
                        <div class="text-sm text-gray-500 sm:block hidden">Color: ${item.color} • Size: ${item.size}</div>
                        <div class="mt-2 text-sm font-semibold text-indigo-600 sm:block hidden">Stock: ${item.quantity}</div>
                    </div>
                    <div class="flex flex-col space-y-2 no-print">
                        <div class="flex space-x-2">
                            <button onclick="changeStock('${item.id}', 'sell')" class="bg-green-500 text-white px-3 py-1 rounded text-xs">-1 Sell</button>
                            <button onclick="changeStock('${item.id}', 'restock')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs">+1 Stock</button>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editItem('${item.id}')" class="bg-yellow-400 px-3 py-1 rounded text-xs">Edit</button>
                            <button onclick="deleteItem('${item.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-xs">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(itemEl);
            });
            renderFinancials();
        }

        window.changeStock = async (id, type) => {
            const item = currentItems.find(i => i.id === id);
            if (type === 'sell' && item.quantity <= 0) return;
            
            await runTransaction(db, async (t) => {
                const itemRef = doc(db, `artifacts/${appId}/public/data/apparel_inventory`, id);
                t.update(itemRef, { quantity: increment(type === 'sell' ? -1 : 1) });
                
                const ledgerRef = doc(collection(db, `artifacts/${appId}/public/data/sales_ledger`));
                t.set(ledgerRef, {
                    inventoryItemId: id,
                    productName: item.productName,
                    categories: item.categories || [],
                    costAtSale: item.retailCost,
                    priceAtSale: item.sellingPrice,
                    quantitySold: 1,
                    saleDate: Date.now(),
                    type: type === 'sell' ? 'sale' : 'restock'
                });
            });
        };

        window.deleteItem = async (id) => {
            if(confirm('Delete this item?')) await deleteDoc(doc(db, `artifacts/${appId}/public/data/apparel_inventory`, id));
        };

        window.editItem = (id) => {
            const item = currentItems.find(i => i.id === id);
            editingDocId = id;
            document.getElementById('product-name').value = item.productName;
            document.getElementById('retail-cost').value = item.retailCost;
            document.getElementById('selling-price').value = item.sellingPrice;
            document.getElementById('size').value = item.size;
            document.getElementById('quantity').value = item.quantity;
            document.getElementById('color').value = item.color;
            if(!document.getElementById('input-form-section').classList.contains('is-expanded')) toggleForm();
            window.scrollTo({top:0, behavior:'smooth'});
        };

        async function handleFormSubmit(e) {
            e.preventDefault();
            const data = {
                productName: document.getElementById('product-name').value,
                retailCost: parseFloat(document.getElementById('retail-cost').value),
                sellingPrice: parseFloat(document.getElementById('selling-price').value),
                size: document.getElementById('size').value,
                quantity: parseInt(document.getElementById('quantity').value),
                color: document.getElementById('color').value,
                categories: Array.from(document.getElementById('categories').selectedOptions).map(o => o.value),
                timestamp: Date.now()
            };

            if (editingDocId) {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/apparel_inventory`, editingDocId), data);
            } else {
                await addDoc(collection(db, `artifacts/${appId}/public/data/apparel_inventory`), data);
            }
            e.target.reset();
            editingDocId = null;
            toggleForm();
        }

        function toggleForm() {
            const section = document.getElementById('input-form-section');
            const icon = document.getElementById('form-toggle-icon');
            section.classList.toggle('is-expanded');
            icon.classList.toggle('rotate-180');
        }

        function renderCategoriesUI() {
            const select = document.getElementById('categories');
            select.innerHTML = currentCategories.map(c => `<option value="${c}">${c}</option>`).join('');
            const list = document.getElementById('category-list-container');
            list.innerHTML = currentCategories.map(c => `<div class="flex justify-between p-2 bg-white border"><span>${c}</span><button onclick="removeCategory('${c}')" class="text-red-500">×</button></div>`).join('');
        }

        window.removeCategory = async (name) => {
            const names = currentCategories.filter(n => n !== name);
            await updateDoc(doc(db, `artifacts/${appId}/public/data/categories/list`), { names });
        };

        async function handleAddCategory(e) {
            e.preventDefault();
            const name = document.getElementById('new-category-name').value.trim();
            if (name && !currentCategories.includes(name)) {
                const names = [...currentCategories, name].sort();
                await setDoc(doc(db, `artifacts/${appId}/public/data/categories/list`), { names });
            }
            e.target.reset();
        }

        function renderFinancials() {
            let inv = 0, rev = 0, cost = 0, sold = 0;
            currentItems.forEach(i => inv += (i.quantity * i.retailCost));
            currentSales.forEach(s => {
                if(s.type === 'sale' || !s.type) {
                    rev += (s.priceAtSale * s.quantitySold);
                    cost += (s.costAtSale * s.quantitySold);
                    sold += s.quantitySold;
                }
            });
            document.getElementById('total-investment').textContent = `$${inv.toFixed(2)}`;
            document.getElementById('total-revenue').textContent = `$${rev.toFixed(2)}`;
            document.getElementById('total-sold-qty').textContent = sold;
            document.getElementById('total-profit').textContent = `$${(rev - cost).toFixed(2)}`;
        }

        window.scrollToTop = () => window.scrollTo({top:0, behavior:'smooth'});
        init();
    </script>
</body>
</html>