<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated Title -->
    <title>JessaB Designing</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.fonts.gstatic.com/s/inter/v13/UuauZp2EwK8y4XJc5_rSzhwV58T6_J1x1Q.woff2');
        body { font-family: 'Inter', sans-serif; }
        /* Custom style for the requested header background color (light pink/beige) */
        .header-bg {
            background-color: #fcf8f5; 
        }
        /* Style for the collapsible panel */
        .collapsible-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }
        .collapsible-panel.is-expanded {
            max-height: 1000px; 
            padding-top: 1.5rem; 
            padding-bottom: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header Section -->
    <header class="header-bg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">JessaB Designing</h1>
            <div id="authStatus" class="text-sm font-medium text-gray-500">Connecting...</div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Add Item Section (Collapsible) -->
        <section class="mb-8 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <button id="toggleFormBtn" class="w-full px-6 py-4 flex justify-between items-center bg-white hover:bg-gray-50 transition-colors focus:outline-none">
                <span class="text-lg font-semibold text-gray-800">Add New Product</span>
                <svg id="toggleIcon" class="w-5 h-5 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            
            <div id="formSection" class="collapsible-panel px-6">
                <form id="inventoryForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="md:col-span-2 lg:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <input type="text" id="productName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Retail Cost ($)</label>
                        <input type="number" step="0.01" id="retailCost" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Selling Price ($)</label>
                        <input type="number" step="0.01" id="sellingPrice" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Size</label>
                        <input type="text" id="size" placeholder="e.g., Medium, 12x12" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
                        <input type="text" id="color" placeholder="e.g., Blue, Matte Black" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantity in Stock</label>
                        <input type="number" id="quantity" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                    </div>
                    <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                        <button type="submit" class="bg-indigo-600 text-white px-8 py-2.5 rounded-lg font-semibold hover:bg-indigo-700 transition-colors shadow-md focus:ring-4 focus:ring-indigo-200">
                            Add Item to Inventory
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Inventory List Section -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="px-6 py-4 border-b border-gray-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <h2 class="text-xl font-bold text-gray-800">Current Inventory</h2>
                <div class="flex flex-wrap items-center gap-3">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search items..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all w-64">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <button id="printBtn" class="flex items-center gap-2 bg-gray-800 text-white px-4 py-2 rounded-lg font-medium hover:bg-gray-900 transition-colors shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                        </svg>
                        Print Inventory
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 text-sm font-semibold uppercase tracking-wider">
                            <th class="px-6 py-4">Item Details</th>
                            <th class="px-6 py-4">Pricing</th>
                            <th class="px-6 py-4">Stock</th>
                            <th class="px-6 py-4">Sales</th>
                            <th class="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryList" class="divide-y divide-gray-100">
                        <!-- Dynamic items here -->
                    </tbody>
                </table>
            </div>
            
            <div id="emptyState" class="hidden p-12 text-center">
                <div class="flex flex-col items-center">
                    <svg class="w-16 h-16 text-gray-200 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                    </svg>
                    <p class="text-gray-500 text-lg">No inventory items found.</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Simple Back to Top Button -->
    <button id="backToTop" class="fixed bottom-8 right-8 bg-indigo-600 text-white p-3 rounded-full shadow-lg opacity-0 pointer-events-none transition-all hover:bg-indigo-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7 7 7M5 19l7-7 7 7"></path>
        </svg>
    </button>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let currentItems = [];
        let editingDocId = null;

        // UI Elements
        const inventoryForm = document.getElementById('inventoryForm');
        const inventoryList = document.getElementById('inventoryList');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const authStatus = document.getElementById('authStatus');
        const printBtn = document.getElementById('printBtn');
        const backToTopBtn = document.getElementById('backToTop');
        const toggleFormBtn = document.getElementById('toggleFormBtn');
        const formSection = document.getElementById('formSection');
        const toggleIcon = document.getElementById('toggleIcon');

        // Helpers
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        };

        const toggleForm = () => {
            const isExpanded = formSection.classList.toggle('is-expanded');
            toggleIcon.style.transform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
        };

        toggleFormBtn.addEventListener('click', toggleForm);

        const handleScroll = () => {
            if (window.scrollY > 300) {
                backToTopBtn.classList.remove('opacity-0', 'pointer-events-none');
                backToTopBtn.classList.add('opacity-100', 'pointer-events-auto');
            } else {
                backToTopBtn.classList.add('opacity-0', 'pointer-events-none');
                backToTopBtn.classList.remove('opacity-100', 'pointer-events-auto');
            }
        };

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Authentication Initialization
        const initializeFirebase = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
                authStatus.textContent = "Offline Mode";
                authStatus.classList.add('text-red-500');
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                authStatus.innerHTML = `<span class="flex items-center gap-2"><span class="w-2 h-2 bg-green-500 rounded-full"></span> Online</span>`;
                setupInventoryListener();
            } else {
                authStatus.textContent = "Signed Out";
            }
        });

        // Firestore Operations
        const setupInventoryListener = () => {
            if (!currentUser) return;
            const collectionPath = collection(db, 'artifacts', appId, 'public', 'data', 'inventory');
            
            onSnapshot(collectionPath, (snapshot) => {
                currentItems = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                renderInventory();
            }, (error) => {
                console.error("Snapshot error:", error);
            });
        };

        const saveProduct = async (data, id = null) => {
            if (!currentUser) return;
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventory');
            
            try {
                if (id) {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id);
                    await updateDoc(docRef, data);
                } else {
                    await addDoc(collectionRef, data);
                }
            } catch (error) {
                console.error("Save error:", error);
            }
        };

        const updateSales = async (id, currentSales, stock) => {
            if (stock <= 0) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id);
            await updateDoc(docRef, {
                salesQuantity: (currentSales || 0) + 1,
                quantity: stock - 1
            });
        };

        const deleteItem = async (id) => {
            if (!confirm('Are you sure you want to remove this item?')) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id);
            await deleteDoc(docRef);
        };

        const editItem = (item) => {
            editingDocId = item.id;
            document.getElementById('productName').value = item.productName;
            document.getElementById('retailCost').value = item.retailCost;
            document.getElementById('sellingPrice').value = item.sellingPrice;
            document.getElementById('size').value = item.size || '';
            document.getElementById('color').value = item.color || '';
            document.getElementById('quantity').value = item.quantity;
            
            const submitButton = inventoryForm.querySelector('button[type=\"submit\"]');
            submitButton.textContent = 'Update Product Details';
            submitButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            submitButton.classList.add('bg-orange-500', 'hover:bg-orange-600');
            
            // Auto-expand form if it's collapsed
            if (!formSection.classList.contains('is-expanded')) {
                toggleForm();
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // UI Updates
        const renderInventory = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredItems = currentItems.filter(item => 
                item.productName.toLowerCase().includes(searchTerm) || 
                (item.color && item.color.toLowerCase().includes(searchTerm))
            );

            if (filteredItems.length === 0) {
                inventoryList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            inventoryList.innerHTML = filteredItems.map(item => `
                <tr class="hover:bg-gray-50 transition-colors group">
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-900 text-lg">${item.productName}</div>
                        <div class="flex gap-2 mt-1">
                            ${item.size ? `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${item.size}</span>` : ''}
                            ${item.color ? `<span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded">${item.color}</span>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-500">Retail: ${formatCurrency(item.retailCost)}</div>
                        <div class="text-base font-semibold text-green-600">Sell: ${formatCurrency(item.sellingPrice)}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-bold ${item.quantity <= 2 ? 'text-red-500' : 'text-gray-800'}">${item.quantity}</span>
                            <span class="text-xs text-gray-400 uppercase font-medium">Available</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <span class="text-lg font-bold text-indigo-600">${item.salesQuantity || 0}</span>
                            <button onclick="window.updateSales('${item.id}', ${item.salesQuantity || 0}, ${item.quantity})" 
                                class="bg-indigo-50 text-indigo-600 p-1.5 rounded-full hover:bg-indigo-600 hover:text-white transition-all disabled:opacity-30 disabled:cursor-not-allowed"
                                ${item.quantity <= 0 ? 'disabled' : ''}
                                title="Mark one as sold">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick='window.editItem(${JSON.stringify(item).replace(/'/g, "&apos;")})' class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="window.deleteItem('${item.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        };

        // Compact Print Inventory - Single lines per item
        const printItems = () => {
            const printWindow = window.open('', '_blank');
            const items = currentItems;
            
            let tableRows = items.map(item => `
                <tr>
                    <td>${item.productName}</td>
                    <td>${item.size || '-'}</td>
                    <td>${item.color || '-'}</td>
                    <td style="text-align: center;">${item.quantity}</td>
                </tr>
            `).join('');

            printWindow.document.write(`
                <html>
                    <head>
                        <title>JessaB Designing Inventory</title>
                        <style>
                            @page { margin: 1cm; }
                            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: #000; padding: 0; margin: 0; font-size: 10pt; }
                            h1 { font-size: 16pt; margin: 0 0 10px 0; border-bottom: 2px solid #000; padding-bottom: 5px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                            th { text-align: left; padding: 4px; border-bottom: 1px solid #000; font-size: 9pt; text-transform: uppercase; }
                            td { padding: 4px; border-bottom: 1px solid #eee; }
                            .header-meta { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px; font-size: 8pt; color: #555; }
                        </style>
                    </head>
                    <body>
                        <div class="header-meta">
                            <span>JessaB Designing</span>
                            <span>Printed: ${new Date().toLocaleDateString()}</span>
                        </div>
                        <h1>Inventory Report</h1>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Product Name</th>
                                    <th style="width: 20%;">Size</th>
                                    <th style="width: 25%;">Color</th>
                                    <th style="width: 15%; text-align: center;">Qty</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        };

        // Exposure for inline HTML handlers
        window.updateSales = updateSales;
        window.deleteItem = deleteItem;
        window.editItem = editItem;

        // Event Listeners
        searchInput.addEventListener('input', renderInventory);
        printBtn.addEventListener('click', printItems);

        inventoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productName = document.getElementById('productName').value;
            const retailCost = parseFloat(document.getElementById('retailCost').value);
            const sellingPrice = parseFloat(document.getElementById('sellingPrice').value);
            const size = document.getElementById('size').value;
            const color = document.getElementById('color').value;
            const quantity = parseInt(document.getElementById('quantity').value);

            if (isNaN(retailCost) || isNaN(sellingPrice) || isNaN(quantity)) {
                 alert("Please enter valid numbers.");
                 return;
            }

            const productData = {
                productName,
                retailCost: retailCost,
                sellingPrice: sellingPrice,
                size,
                quantity: quantity, 
                salesQuantity: editingDocId ? (currentItems.find(i => i.id === editingDocId)?.salesQuantity || 0) : 0, 
                color,
                timestamp: Date.now(), 
            };

            await saveProduct(productData, editingDocId);
            
            // Reset form and state after successful save/update
            inventoryForm.reset();
            editingDocId = null;
            const submitButton = inventoryForm.querySelector('button[type="submit"]');
            submitButton.textContent = 'Add Item to Inventory';
            submitButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            submitButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            
            // Collapse the form after adding/updating
            if (formSection.classList.contains('is-expanded')) {
                toggleForm();
            }
        });

        if (backToTopBtn) {
            window.addEventListener('scroll', handleScroll);
        }

        window.onload = initializeFirebase;
    </script>
</body>
</html>