<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apparel Inventory Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.fonts.gstatic.com/s/inter/v13/UuauZp2EwK8y4XJc5_rSzhwV58T6_J1x1Q.woff2');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-6 md:p-8">

    <div id="app-container" class="max-w-4xl mx-auto">
        <header class="mb-8 p-4 bg-white rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mr-3 text-indigo-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.124.75.75 0 0 1-.72 2.115.75.75 0 0 0 .15 1.13 1 1 0 0 0 .524.364l4.475 1.571a.75.75 0 0 0 .73-.133.75.75 0 0 0 .182-.578v-4.18a.75.75 0 0 1 .53-.721L12 15.346l1.378-.492a.75.75 0 0 1 .53.722v4.18a.75.75 0 0 0 .182.578.75.75 0 0 0 .73.133l4.475-1.571a.75.75 0 0 0 .524-.364.75.75 0 0 0-.72-2.115 3 3 0 0 0-5.78-1.124V5.722a.75.75 0 0 0-1.5 0v10.402Z" />
                </svg>
                Apparel Inventory
            </h1>
            <p class="text-sm text-gray-500 mt-1">Real-time tracking for your side gig. All data is shared.</p>
            <div id="auth-info" class="text-xs mt-3 p-2 bg-indigo-50 text-indigo-700 rounded-md">
                <span id="user-id-display">Loading User ID...</span>
            </div>
        </header>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center p-8 text-indigo-600 font-medium">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Connecting to inventory database...
        </div>

        <!-- Inventory Form Section -->
        <div id="input-form-section" class="bg-white p-6 rounded-lg shadow-xl mb-8 hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Add New Item / Edit Details</h2>
            <form id="inventory-form" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                
                <!-- Product Name -->
                <div class="col-span-2 sm:col-span-3">
                    <label for="product-name" class="block text-sm font-medium text-gray-700">Product Name</label>
                    <input type="text" id="product-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>

                <!-- Retail Cost (COGS) -->
                <div>
                    <label for="retail-cost" class="block text-sm font-medium text-gray-700">Retail Cost ($)</label>
                    <input type="number" step="0.01" id="retail-cost" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" min="0">
                </div>

                <!-- Selling Price -->
                <div>
                    <label for="selling-price" class="block text-sm font-medium text-gray-700">Selling Price ($)</label>
                    <input type="number" step="0.01" id="selling-price" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" min="0">
                </div>

                <!-- Size -->
                <div>
                    <label for="size" class="block text-sm font-medium text-gray-700">Size (e.g., L, 32x30)</label>
                    <input type="text" id="size" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>

                <!-- Quantity (Initial/Current Stock for Add/Edit) -->
                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-700">Starting/Current Stock</label>
                    <input type="number" step="1" id="quantity" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" min="1">
                </div>

                <!-- Color -->
                <div class="col-span-2 sm:col-span-1">
                    <label for="color" class="block text-sm font-medium text-gray-700">Color/Variant</label>
                    <input type="text" id="color" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>

                <!-- Submit Button -->
                <div class="col-span-2 sm:col-span-3 mt-2">
                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        Add Item to Inventory
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Search Input Field -->
        <div id="search-section" class="mb-6 hidden">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.197 5.197a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                </div>
                <input type="text" id="search-input" placeholder="Search inventory by Name, Size, or Color..." class="block w-full rounded-lg border-0 py-3 pl-10 pr-4 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 shadow-md transition duration-150">
            </div>
        </div>

        <!-- Inventory List Section -->
        <div id="inventory-list-section" class="bg-white p-4 sm:p-6 rounded-lg shadow-xl mb-8 hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Current Inventory Stock & Sales</h2>
            
            <div id="inventory-container" class="space-y-4">
                <!-- Items will be injected here -->
            </div>

            <p id="no-items-message" class="text-gray-500 text-center py-8 hidden">
                Your inventory is currently empty. Add an item above to get started!
            </p>
        </div>
        
        <!-- Financial Summary Section - UPDATED GRID AND NEW METRIC -->
        <div id="financial-summary" class="bg-indigo-700 p-4 sm:p-6 rounded-lg shadow-xl text-white mt-8 hidden">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2 text-indigo-300">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.03 60.03 0 0 0 18 0m-18 0v-2.25c0-1.31.25-2.58.73-3.72M2.25 18.75c-.32 0-.49-.13-.72-.37-.23-.24-.37-.41-.37-.73v-2.25c0-.62.08-1.22.24-1.8m.72 4.35v-2.25c0-.62.08-1.22.24-1.8m17.52 4.35v-2.25c0-.62.08-1.22.24-1.8m.24 4.05c.48-1.14.73-2.41.73-3.72V15c0-1.31-.25-2.58-.73-3.72m-17.52 7.8c.48-1.14.73-2.41.73-3.72V15c0-1.31-.25-2.58-.73-3.72M21.75 18.75c.32 0 .49-.13.72-.37.23-.24.37-.41.37-.73v-2.25c0-.62-.08-1.22-.24-1.8" />
                </svg>
                Overall Financial Summary
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                
                <div class="bg-white/10 p-4 rounded-md">
                    <p class="text-sm font-medium text-indigo-200">Total Stock Investment</p>
                    <p id="total-investment" class="text-2xl font-extrabold mt-1">$0.00</p>
                    <p class="text-xs text-indigo-300">(Cost of stock on hand)</p>
                </div>
                
                <!-- NEW: Total Sold Units Card -->
                <div class="bg-white/10 p-4 rounded-md">
                    <p class="text-sm font-medium text-indigo-200">Total Sold Units</p>
                    <p id="total-sold-qty" class="text-2xl font-extrabold mt-1">0</p>
                    <p class="text-xs text-indigo-300">(All units recorded as sold)</p>
                </div>

                <div class="bg-white/10 p-4 rounded-md">
                    <p class="text-sm font-medium text-indigo-200">Total Realized Revenue</p>
                    <p id="total-revenue" class="text-2xl font-extrabold mt-1">$0.00</p>
                    <p class="text-xs text-indigo-300">(Money collected from sales)</p>
                </div>

                <div class="bg-white/20 p-4 rounded-md border-2 border-green-300">
                    <p class="text-sm font-medium text-green-300">TOTAL REALIZED PROFIT</p>
                    <p id="total-profit" class="text-3xl font-extrabold mt-1">$0.00</p>
                    <p class="text-xs text-indigo-300">(Revenue - Cost of goods sold)</p>
                </div>
            </div>
        </div>

        <!-- Custom Modal for Confirmation/Error -->
        <div id="custom-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="modal-content" class="text-sm text-gray-500"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="modal-close-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none transition duration-150">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- MANDATORY FIREBASE SETUP ---
        setLogLevel('error'); 

        // Global variables for Firebase objects and current data state
        let app, db, auth, userId = null;
        let currentItems = []; // Stores the latest snapshot data for quick lookups

        // Configuration retrieval
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const COLLECTION_PATH = `artifacts/${appId}/public/data/apparel_inventory`;

        // UI elements
        const loadingEl = document.getElementById('loading');
        const formSection = document.getElementById('input-form-section');
        const listSection = document.getElementById('inventory-list-section');
        const inventoryForm = document.getElementById('inventory-form');
        const inventoryContainer = document.getElementById('inventory-container');
        const noItemsMessage = document.getElementById('no-items-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const financialSummary = document.getElementById('financial-summary');
        const totalInvestmentEl = document.getElementById('total-investment');
        const totalRevenueEl = document.getElementById('total-revenue');
        const totalProfitEl = document.getElementById('total-profit');
        const searchSection = document.getElementById('search-section'); 
        const searchInput = document.getElementById('search-input');
        const totalSoldQtyEl = document.getElementById('total-sold-qty'); // ADDED

        // Modal elements
        const modalEl = document.getElementById('custom-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalContentEl = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // State for editing
        let editingDocId = null;

        // --- UTILITY FUNCTIONS ---

        function showModal(title, content) {
            modalTitleEl.textContent = title;
            modalContentEl.textContent = content;
            modalEl.classList.remove('hidden');
        }

        modalCloseBtn.onclick = () => {
            modalEl.classList.add('hidden');
        };

        // Function to handle exponential backoff and retry (simplified version for context)
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    console.error(`Fetch attempt ${i + 1} failed:`, error);
                    if (i === maxRetries - 1) throw error; 
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                showModal("Configuration Error", "Firebase configuration is missing. Cannot initialize the app.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for the auth state to settle
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.innerHTML = `You are authenticated with User ID: <strong>${userId}</strong>. Your data is collaborative.`;
                        
                        // Show the app UI and start listening to data
                        loadingEl.classList.add('hidden');
                        formSection.classList.remove('hidden');
                        listSection.classList.remove('hidden');
                        financialSummary.classList.remove('hidden'); 
                        searchSection.classList.remove('hidden');
                        loadProducts();
                        
                        // Attach search listener after auth/UI setup
                        searchInput.addEventListener('input', () => {
                            renderInventory(currentItems);
                        });

                    } else {
                        userIdDisplay.textContent = "Authentication failed.";
                        loadingEl.classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showModal("Initialization Failed", `An error occurred during startup: ${error.message}`);
            }
        }
        
        // --- CRUD OPERATIONS ---

        // 1. Save (Add/Update) Product
        async function saveProduct(productData, docId = null) {
            if (!db) {
                console.error("Database not initialized.");
                return;
            }

            try {
                if (docId) {
                    const docRef = doc(db, COLLECTION_PATH, docId);
                    await updateDoc(docRef, productData);
                } else {
                    await addDoc(collection(db, COLLECTION_PATH), productData);
                }
                showModal("Success!", `Inventory item ${docId ? 'updated' : 'added'} successfully.`);
            } catch (error) {
                console.error("Error saving product:", error);
                showModal("Database Error", `Failed to save item: ${error.message}`);
            }
        }
        
        // 2. Update Stock/Sales Quantity
        async function updateStock(docId, changeType) {
            if (!db) return;

            try {
                const docRef = doc(db, COLLECTION_PATH, docId);
                let updatePayload = {};

                if (changeType === 'sell') {
                    updatePayload = {
                        quantity: increment(-1),
                        salesQuantity: increment(1)
                    };
                } else if (changeType === 'restock') {
                    updatePayload = {
                        quantity: increment(1)
                    };
                } else {
                    return;
                }

                await updateDoc(docRef, updatePayload);
            } catch (error) {
                console.error(`Error updating stock (${changeType}):`, error);
                showModal("Update Error", `Failed to update inventory: ${error.message}`);
            }
        }


        // 3. Delete Product
        async function deleteProduct(docId) {
            if (!db) return;

            // Custom modal for confirmation
            const confirmDelete = () => new Promise(resolve => {
                const tempModalTitle = modalTitleEl.textContent;
                const tempModalContent = modalContentEl.textContent;
                const itemsCenterDiv = modalCloseBtn.parentElement;
                const originalContent = itemsCenterDiv.innerHTML;

                modalTitleEl.textContent = "Confirm Deletion";
                modalContentEl.textContent = "Are you sure you want to delete this inventory item? This cannot be undone.";
                
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-1/2 shadow-sm hover:bg-red-700 transition duration-150 mr-2';

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.className = 'px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md w-1/2 shadow-sm hover:bg-gray-400 transition duration-150';

                itemsCenterDiv.innerHTML = '';
                itemsCenterDiv.appendChild(deleteButton);
                itemsCenterDiv.appendChild(cancelButton);

                modalEl.classList.remove('hidden');

                const restoreModal = () => {
                    modalTitleEl.textContent = tempModalTitle;
                    modalContentEl.textContent = tempModalContent;
                    itemsCenterDiv.innerHTML = originalContent; 
                    modalEl.classList.add('hidden');
                };

                deleteButton.onclick = () => { resolve(true); restoreModal(); };
                cancelButton.onclick = () => { resolve(false); restoreModal(); };
            });

            if (await confirmDelete()) {
                try {
                    await deleteDoc(doc(db, COLLECTION_PATH, docId));
                    showModal("Deleted", "Item successfully removed from inventory.");
                } catch (error) {
                    console.error("Error deleting product:", error);
                    showModal("Database Error", `Failed to delete item: ${error.message}`);
                }
            }
        }

        // 4. Load Products (Real-time with onSnapshot)
        function loadProducts() {
            if (!db) return;

            const q = query(collection(db, COLLECTION_PATH));

            onSnapshot(q, (snapshot) => {
                const items = [];
                snapshot.forEach((doc) => {
                    items.push({ id: doc.id, ...doc.data() });
                });
                
                currentItems = items; // Update the global state
                renderInventory(currentItems); // Render the full list (which handles filtering)
            }, (error) => {
                console.error("Error fetching documents:", error);
                showModal("Data Error", `Could not load inventory: ${error.message}`);
            });
        }
        
        // --- UI RENDERING & EVENT HANDLERS ---
        
        function editProduct(item) {
            editingDocId = item.id;
            document.getElementById('product-name').value = item.productName;
            document.getElementById('retail-cost').value = item.retailCost;
            document.getElementById('selling-price').value = item.sellingPrice;
            document.getElementById('size').value = item.size;
            document.getElementById('quantity').value = item.quantity; 
            document.getElementById('color').value = item.color;
            
            const submitButton = inventoryForm.querySelector('button[type="submit"]');
            submitButton.textContent = 'Update Item Details';
            submitButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            submitButton.classList.add('bg-orange-500', 'hover:bg-orange-600');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Render the list of inventory items AND calculate totals
        function renderInventory(items) {
            inventoryContainer.innerHTML = '';

            // Filtering Logic
            const searchTerm = searchInput.value.toLowerCase().trim();
            const filteredItems = items.filter(item => {
                // Search across Name, Size, and Color fields
                const searchString = `${item.productName} ${item.size} ${item.color}`.toLowerCase();
                return searchString.includes(searchTerm);
            });


            // Initialize accumulators for totals
            // NOTE: Only used for calculating totals across ALL items, not filtered.
            let totalInvestment = 0;
            let totalRealizedRevenue = 0;
            let totalRealizedCostOfSoldGoods = 0;
            let totalSoldQuantity = 0; // NEW: ACCUMULATOR

            if (filteredItems.length === 0) {
                noItemsMessage.classList.remove('hidden');
            } else {
                noItemsMessage.classList.add('hidden');
            }
            
            // Sort by product name
            filteredItems.sort((a, b) => a.productName.localeCompare(b.productName));

            filteredItems.forEach(item => {
                // Calculations
                const retailCost = parseFloat(item.retailCost);
                const sellingPrice = parseFloat(item.sellingPrice);
                const currentStock = parseInt(item.quantity, 10);
                const salesQuantity = parseInt(item.salesQuantity || 0, 10); 
                
                const grossProfitPerUnit = sellingPrice - retailCost;
                const totalProfitFromSales = grossProfitPerUnit * salesQuantity; 
                
                const grossProfitColor = grossProfitPerUnit > 0 ? 'text-green-600' : 'text-red-500';
                const totalProfitColor = totalProfitFromSales > 0 ? 'text-green-700' : (totalProfitFromSales < 0 ? 'text-red-700' : 'text-gray-700');

                // The aggregation happens below in the global calculation loop, 
                // but we can leave the per-item calculation here for clarity:
                
                const itemHtml = `
                    <div class="bg-white p-4 border border-gray-100 rounded-lg shadow-md hover:shadow-lg transition duration-200 sm:flex sm:justify-between sm:items-center">
                        <!-- Item Details (Left Side) -->
                        <div class="flex-grow mb-3 sm:mb-0">
                            <div class="text-lg font-bold text-gray-800">${item.productName}</div>
                            <div class="text-sm text-gray-500">Size: ${item.size} â€¢ Color: ${item.color}</div>
                            
                            <div class="mt-2 grid grid-cols-2 text-sm gap-y-1">
                                <!-- Updated display for Stock and Sold -->
                                <div><span class="font-medium text-gray-600">Stock Qty:</span> <span class="text-indigo-600 font-semibold">${currentStock}</span></div>
                                <div><span class="font-medium text-gray-600">Sold Qty:</span> <span class="text-indigo-600 font-semibold">${salesQuantity}</span></div>
                                
                                <div><span class="font-medium text-gray-600">Retail Cost:</span> $${item.retailCost.toFixed(2)}</div>
                                <div><span class="font-medium text-gray-600">Selling Price:</span> $${item.sellingPrice.toFixed(2)}</div>
                            </div>
                        </div>

                        <!-- Financials & Actions (Right Side) -->
                        <div class="sm:ml-4 sm:w-64 flex flex-col space-y-2">
                            <!-- Total Profit from Sales -->
                            <div class="bg-green-50 p-2 rounded-md">
                                <p class="text-xs font-medium text-gray-600">Total Profit (Realized)</p>
                                <p class="${totalProfitColor} font-bold text-lg">$${totalProfitFromSales.toFixed(2)}</p>
                            </div>
                            
                            <!-- Profit Per Unit -->
                            <div class="bg-indigo-50 p-2 rounded-md">
                                <p class="text-xs font-medium text-gray-600">Profit/Unit</p>
                                <p class="${grossProfitPerUnit > 0 ? 'text-green-700' : 'text-red-700'} font-bold text-lg">$${grossProfitPerUnit.toFixed(2)}</p>
                            </div>

                            <!-- Sales/Stock Buttons -->
                            <div class="flex space-x-2">
                                <button data-id="${item.id}" data-action="sell" ${currentStock <= 0 ? 'disabled' : ''} class="flex-1 py-1 text-sm rounded-md bg-green-500 hover:bg-green-600 text-white transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Record Sale (-1)
                                </button>
                                <button data-id="${item.id}" data-action="restock" class="flex-1 py-1 text-sm rounded-md bg-blue-500 hover:bg-blue-600 text-white transition duration-150">
                                    Restock (+1)
                                </button>
                            </div>

                            <!-- Edit/Delete Buttons -->
                            <div class="flex space-x-2">
                                <button data-id="${item.id}" data-action="edit" class="flex-1 py-1 text-sm rounded-md bg-yellow-400 hover:bg-yellow-500 text-gray-800 transition duration-150">Edit Details</button>
                                <button data-id="${item.id}" data-action="delete" class="flex-1 py-1 text-sm rounded-md bg-red-500 hover:bg-red-600 text-white transition duration-150">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                inventoryContainer.innerHTML += itemHtml;
            });

            // --- START: GLOBAL FINANCIAL SUMMARY CALCULATION (Uses ALL items) ---
            let globalTotalInvestment = 0;
            let globalTotalRealizedRevenue = 0;
            let globalTotalRealizedCostOfSoldGoods = 0;
            let globalTotalSoldQuantity = 0; // NEW: Global accumulator

            items.forEach(item => {
                const retailCost = parseFloat(item.retailCost);
                const sellingPrice = parseFloat(item.sellingPrice);
                const currentStock = parseInt(item.quantity, 10);
                const salesQuantity = parseInt(item.salesQuantity || 0, 10); 
                
                globalTotalInvestment += (currentStock * retailCost);
                globalTotalRealizedRevenue += (salesQuantity * sellingPrice);
                globalTotalRealizedCostOfSoldGoods += (salesQuantity * retailCost);
                globalTotalSoldQuantity += salesQuantity; // ACCUMULATE
            });
            
            const finalTotalProfit = globalTotalRealizedRevenue - globalTotalRealizedCostOfSoldGoods;

            // --- END: GLOBAL FINANCIAL SUMMARY CALCULATION ---

            // UPDATE UI ELEMENTS
            totalInvestmentEl.textContent = `$${globalTotalInvestment.toFixed(2)}`;
            totalRevenueEl.textContent = `$${globalTotalRealizedRevenue.toFixed(2)}`;
            totalSoldQtyEl.textContent = globalTotalSoldQuantity; // UPDATED
            totalProfitEl.textContent = `$${finalTotalProfit.toFixed(2)}`;
            
            if (finalTotalProfit < 0) {
                 totalProfitEl.classList.remove('text-green-300');
                 totalProfitEl.classList.add('text-red-300');
                 totalProfitEl.parentElement.classList.remove('border-green-300');
                 totalProfitEl.parentElement.classList.add('border-red-300');
            } else {
                 totalProfitEl.classList.add('text-green-300');
                 totalProfitEl.classList.remove('text-red-300');
                 totalProfitEl.parentElement.classList.add('border-green-300');
                 totalProfitEl.parentElement.classList.remove('border-red-300');
            }
        }
        
        // Global event listener for all item-related buttons
        inventoryContainer.addEventListener('click', (event) => {
            const button = event.target.closest('button');
            if (!button) return;

            const docId = button.dataset.id;
            const action = button.dataset.action;
            const item = currentItems.find(i => i.id === docId); 

            if (!item) {
                console.error("Item not found for action.");
                return;
            }

            if (action === 'edit') {
                editProduct(item);
            } else if (action === 'delete') {
                deleteProduct(docId);
            } else if (action === 'sell') { 
                if (item.quantity > 0) {
                    updateStock(docId, 'sell');
                } else {
                    showModal("Stock Zero", "Cannot record a sale: Stock quantity is already 0.");
                }
            } else if (action === 'restock') { 
                updateStock(docId, 'restock');
            }
        });

        // Form submission handler
        inventoryForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const productName = document.getElementById('product-name').value.trim();
            const retailCost = parseFloat(document.getElementById('retail-cost').value);
            const sellingPrice = parseFloat(document.getElementById('selling-price').value);
            const size = document.getElementById('size').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value, 10);
            const color = document.getElementById('color').value.trim();
            
            if (retailCost < 0 || sellingPrice < 0 || quantity <= 0) {
                 showModal("Input Error", "Cost, price, and initial quantity must be valid positive numbers.");
                 return;
            }

            const productData = {
                productName,
                retailCost: retailCost,
                sellingPrice: sellingPrice,
                size,
                quantity: quantity, 
                salesQuantity: editingDocId ? (currentItems.find(i => i.id === editingDocId)?.salesQuantity || 0) : 0, 
                color,
                timestamp: Date.now(), 
            };

            await saveProduct(productData, editingDocId);
            
            // Reset form and state after successful save/update
            inventoryForm.reset();
            editingDocId = null;
            const submitButton = inventoryForm.querySelector('button[type="submit"]');
            submitButton.textContent = 'Add Item to Inventory';
            submitButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            submitButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        });

        // Start the application
        window.onload = initializeFirebase;
    </script>
</body>
</html>